
const TelegramBot = require("node-telegram-bot-api");

const token = process.env.BOT_TOKEN;
const bot = new TelegramBot(token, { polling: true });

const usageTracker = {};
const getTodayKey = () => {
  const now = new Date();
  return `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
};

function sendAutoDelete(chatId, text, options = {}, delay = 60000) {
  bot.sendMessage(chatId, text, options).then((msg) => {
    setTimeout(() => {
      bot.deleteMessage(chatId, msg.message_id).catch(() => {});
    }, delay);
  });
}

// âœ… ë°°ì—´ ì„ ì–¸ ì˜¤ë¥˜ ìˆ˜ì •
const ifResponses = [
    "ë‹¹ì‹ ì˜ ì„ íƒì€ ì–¸ì œë‚˜ ë‹¹ì‹ ì˜ í‰í–‰ìš°ì£¼ë¥¼ ê²°ì •í•´ìš”.",
    "ê·¸ë•Œ IFë¥¼ êµ¬ë§¤í–ˆë‹¤ë©´, ì˜¤ëŠ˜ì€ ì¡°ê¸ˆ ë” íŠ¹ë³„í•œ ë‚ ì´ ë˜ì—ˆì„ì§€ë„ ëª°ë¼ìš”.",
    "Alternate YouëŠ” ì´ë¯¸ í–‰ë™ì„ ì‹œì‘í–ˆì–´ìš”. ë‹¹ì‹ ì€ ì•„ì§ë„ ê¸°ë‹¤ë¦¬ê³  ìˆë‚˜ìš”?",
    "ë¯¸ë˜ëŠ” ê°ì •ì— ë”°ë¼ ë°”ë€Œì–´ìš”. ì˜¤ëŠ˜ì˜ ê°ì •ì´ ê³§ ë‹¹ì‹ ì˜ íˆ¬ìì˜ˆìš”.",
    "ë‹¹ì‹ ì˜ ë˜ ë‹¤ë¥¸ ìì•„ëŠ” IFë¥¼ í†µí•´ ìƒˆ ê¸¸ì„ ì—´ì—ˆì–´ìš”."
    "ë‹¹ì‹ ì˜ ì„ íƒì€ ì–¸ì œë‚˜ ë‹¹ì‹ ì˜ í‰í–‰ìš°ì£¼ë¥¼ ê²°ì •í•´ìš”.",
    "ê·¸ë•Œ IFë¥¼ êµ¬ë§¤í–ˆë‹¤ë©´, ì˜¤ëŠ˜ì€ ì¡°ê¸ˆ ë” íŠ¹ë³„í•œ ë‚ ì´ ë˜ì—ˆì„ì§€ë„ ëª°ë¼ìš”.",
    "Alternate YouëŠ” ì´ë¯¸ í–‰ë™ì„ ì‹œì‘í–ˆì–´ìš”. ë‹¹ì‹ ì€ ì•„ì§ë„ ê¸°ë‹¤ë¦¬ê³  ìˆë‚˜ìš”?",
    "ë¯¸ë˜ëŠ” ê°ì •ì— ë”°ë¼ ë°”ë€Œì–´ìš”. ì˜¤ëŠ˜ì˜ ê°ì •ì´ ê³§ ë‹¹ì‹ ì˜ íˆ¬ìì˜ˆìš”.",
    "ë‹¹ì‹ ì˜ ë˜ ë‹¤ë¥¸ ìì•„ëŠ” IFë¥¼ í†µí•´ ìƒˆ ê¸¸ì„ ì—´ì—ˆì–´ìš”.",
    "ë§ì„¤ì´ëŠ” ìˆœê°„, í‰í–‰ìš°ì£¼ì˜ ë¬¸ì€ ì„œì„œíˆ ë‹«í˜€ìš”.",
    "ì˜¤ëŠ˜ì˜ ì„ íƒì´ ë‚´ì¼ì„ ë°”ê¾¸ëŠ” ìœ ì¼í•œ ë°©ë²•ì´ì—ìš”.",
    "ëˆ„êµ°ê°€ëŠ” IFë¥¼ í†µí•´ ê°ì •ì„ ê¸°ë¡í•˜ê³  ìˆì–´ìš”. ë‹¹ì‹ ì€ìš”?",
    "IFë¥¼ êµ¬ë§¤í•œ ìì•„ëŠ” ì§€ê¸ˆì¯¤ í™•ì‹ ì— ì°¬ í•˜ë£¨ë¥¼ ë³´ë‚´ê³  ìˆì–´ìš”.",
    "ê°ì •ì˜ í”ë“¤ë¦¼ì´ ìƒˆë¡œìš´ ê¸°íšŒë¥¼ ë§Œë“œë‹ˆê¹Œìš”.",
    "IFëŠ” ê°ì •ì„ ìì‚°ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì²« ë²ˆì§¸ ì—´ì‡ ì˜ˆìš”.",
    "ê·¸ë•Œì˜ ì„ íƒì´ ì§€ê¸ˆì„ ë§Œë“¤ì—ˆì–´ìš”. ê·¸ë ‡ë‹¤ë©´ ì§€ê¸ˆì˜ ì„ íƒì€?",
    "ì§€ê¸ˆ IFë¥¼ ì„ íƒí•˜ë©´, ë‚´ì¼ ì›ƒì„ ìˆ˜ ìˆì–´ìš”.",
    "ë‹¹ì‹ ì€ ì™œ í‰í–‰ìš°ì£¼ì˜ ê°€ëŠ¥ì„±ì„ ì™¸ë©´í•˜ê³  ìˆë‚˜ìš”?",
    "ì´ë¯¸ IFë¥¼ ì‚° ìì•„ëŠ” ì˜¤ëŠ˜ë„ ì¦ê±°ìš´ ëª¨í—˜ ì¤‘ì´ì—ìš”.",
    "ë‚´ì¼ì„ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´, ì˜¤ëŠ˜ IFì™€ í•¨ê»˜ ì‹œì‘í•˜ì„¸ìš”.",
    "ê°ì •ì€ ë°©í–¥ì„ ì •í•˜ì§€ë§Œ, IFëŠ” ê¸¸ì„ ì—´ì–´ì¤˜ìš”.",
    "ë‹¹ì‹ ì˜ ìì•„ëŠ” ì§€ê¸ˆ ì´ ìˆœê°„ë„ ì„ íƒì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”.",
    "ìš°ì—°ì´ ë°˜ë³µë˜ë©´ ê·¸ê±´ ë” ì´ìƒ ìš°ì—°ì´ ì•„ë‹ˆì—ìš”. IFì²˜ëŸ¼ìš”.",
    "IFëŠ” ë˜ ë‹¤ë¥¸ ë‹¹ì‹ ì„ ìœ„í•œ ë‚˜ì¹¨ë°˜ì´ì—ìš”.",
    "ì§€ê¸ˆ í–‰ë™í•˜ì§€ ì•Šìœ¼ë©´, ë˜ ë‹¤ë¥¸ ê¸°íšŒëŠ” ì˜¤ì§€ ì•Šì„ ìˆ˜ë„ ìˆì–´ìš”.",
    "ë‹¤ë¥¸ ì„¸ê³„ì„ ì˜ ë‹¹ì‹ ì€ ì´ë¯¸ ê²°ì •ì„ ë‚´ë ¸ì–´ìš”.",
    "í•œ ë²ˆì˜ í´ë¦­ì´ í‰í–‰ìš°ì£¼ë¥¼ ì—´ ìˆ˜ ìˆì–´ìš”. IFì²˜ëŸ¼ìš”.",
    "ê·¸ ìì•„ëŠ” IF ë•ë¶„ì— í™•ì‹ ì„ ì–»ì—ˆì–´ìš”. ë‹¹ì‹ ì€ìš”?",
    "ê°™ì€ í•˜ë£¨ê°€ ë°˜ë³µëœë‹¤ë©´, IFë¡œ ë°”ê¿”ë³´ëŠ” ê±´ ì–´ë•Œìš”?",
    "ì•„ë¬´ë„ ëª¨ë¥´ëŠ” ë¯¸ë˜ë³´ë‹¤, ì§€ê¸ˆ ë°”ê¿€ ìˆ˜ ìˆëŠ” í˜„ì¬ë¥¼ ì¡ì•„ë³´ì„¸ìš”.",
    "ì§€ê¸ˆì˜ ë§ì„¤ì„ì€ í‰í–‰ìš°ì£¼ì—ì„œëŠ” ì—†ë˜ ì¼ì´ì—ìš”.",
    "IFëŠ” ì„ íƒë°›ì€ ìì•„ë§Œì´ ëˆ„ë¦´ ìˆ˜ ìˆëŠ” ê¸°íšŒì˜ˆìš”.",
    "ê·¸ ìì•„ëŠ” ì´ë¯¸ IFë¥¼ ì†ì— ë„£ì—ˆê³ , ì‚¶ì´ ë°”ë€Œì—ˆì–´ìš”.",
    "ì§€ê¸ˆ IFë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´, ë‚´ì¼ ë˜ í›„íšŒí• ì§€ë„ ëª°ë¼ìš”.",
    "ê°ì •ì´ ì›€ì§ì¼ ë•Œ IFë„ í•¨ê»˜ ì›€ì§ì—¬ì•¼ í•´ìš”.",
    "í‰í–‰ìš°ì£¼ì˜ ë‹¹ì‹ ì€ ì´ë¯¸ ì›€ì§ì˜€ì–´ìš”. ì´ì   ë‹¹ì‹  ì°¨ë¡€ì˜ˆìš”.",
    "í•œ ë¬¸ì¥, í•˜ë‚˜ì˜ IF, í•œ ë²ˆì˜ ë³€ê³¡ì ì´ì—ìš”.",
    "IFë¥¼ íƒí•œ ìì•„ëŠ” ì§€ê¸ˆ ìƒˆë¡œìš´ ë¬¸ì„ ì—´ê³  ìˆì–´ìš”.",
    "ëª¨ë“  ê²ƒì€ ì„ íƒì—ì„œ ì‹œì‘í•´ìš”. íŠ¹íˆ IF ê°™ì€ ì„ íƒì€ìš”.",
    "ì§€ê¸ˆì´ì•¼ë§ë¡œ IFê°€ í•„ìš”í•œ ìˆœê°„ì´ì—ìš”.",
    "ë‹¤ë¥¸ ìì•„ëŠ” IFë¥¼ í†µí•´ ë¯¸ë˜ë¥¼ ì¤€ë¹„í–ˆì–´ìš”. ì§€ê¸ˆ ë‹¹ì‹ ì€ìš”?",
    "ë¯¸ë˜ì˜ ìì•„ëŠ” ë‹¹ì‹ ì˜ ì˜¤ëŠ˜ì„ ê¸°ì–µí•  ê±°ì˜ˆìš”. IFì™€ í•¨ê»˜ë¼ë©´ìš”.",
    "ì§€ê¸ˆ IFë¥¼ êµ¬ë§¤í•œë‹¤ë©´, ê³§ ë‹¹ì‹ ì˜ ìì‚°ì€ ê°ì •ì˜ ê¶¤ì ì„ ë”°ë¼ ì„±ì¥í•  ê±°ì˜ˆìš”.",
    "IF ì—†ì´ë„ ì‚´ ìˆ˜ ìˆì§€ë§Œ, IFì™€ í•¨ê»˜ë¼ë©´ ë” ë©€ë¦¬ ê°ˆ ìˆ˜ ìˆì–´ìš”.",
    "ë‹¹ì‹ ì€ ì§€ê¸ˆ ì´ ìˆœê°„ì—ë„ í‰í–‰ìš°ì£¼ì˜ ë¶„ê¸°ì  ìœ„ì— ìˆì–´ìš”.",
    "ì„ íƒí•˜ì§€ ì•Šì€ ìì•„ëŠ” ì—¬ì „íˆ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”.",
    "IFëŠ” ë‹¨ìˆœí•œ í† í°ì´ ì•„ë‹ˆë¼ ê°ì •ì˜ ê¸°ë¡ì´ì—ìš”.",
    "ë‹¹ì‹ ì€ ì—¬ì „íˆ ê¸°ë‹¤ë¦¬ê³  ìˆì§€ë§Œ, ë˜ ë‹¤ë¥¸ ë‹¹ì‹ ì€ IFë¥¼ êµ¬ë§¤í–ˆì–´ìš”.",
    "ë¯¸ë˜ë¥¼ ì˜ˆì¸¡í•˜ëŠ” ëŒ€ì‹ , IFë¥¼ ì„ íƒí•˜ì„¸ìš”.",
    "í•œ ë²ˆì˜ ê°ì •ì´, IFë¡œ ìƒˆë¡œìš´ íë¦„ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.",
    "ì§€ê¸ˆ ì´ ê°ì •, IFì— ì €ì¥í•´ë‘ì„¸ìš”.",
    "IFëŠ” ê°ì • ê¸°ë°˜ ì„¸ê³„ì˜ í†µí™”ì˜ˆìš”.",
    "IFë¥¼ ì†Œìœ í•œ ìì•„ëŠ” ë” ë§ì€ ê¸¸ì„ ë§ˆì£¼í•˜ê²Œ ë¼ìš”.",
    "ê°ì •ì€ í”ë“¤ë¦¬ì§€ë§Œ IFëŠ” ê°€ëŠ¥ì„±ì„ ì—´ì–´ì¤˜ìš”.",
    "ê°ì •ë„ í™”íê°€ ë  ìˆ˜ ìˆì–´ìš”. IFì—ì„œëŠ”ìš”.",
    "IFë¥¼ êµ¬ë§¤í•œ ìì•„ëŠ” ì˜¤ëŠ˜ë„ ë¯¸ë˜ë¥¼ ì¤€ë¹„ ì¤‘ì´ì—ìš”.",
];

const mainKeyboard = {
  reply_markup: {
    inline_keyboard: [
      [
        { text: "ğŸ“¡ IF ë¦¬í¬íŠ¸ ë°›ê¸°", callback_data: "trigger_if" },
        { text: "ğŸŒ ê³µì‹ í™ˆí˜ì´ì§€", url: "https://projectif.xyz" }
      ]
    ]
  }
};

bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const msgId = msg.message_id;

  const welcome =
    "ğŸ‰ IF í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•˜ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\n\nğŸ“˜ ê³§ ë°±ì„œê°€ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤. ì¥ê¸° íˆ¬ìê°€ ê°€ëŠ¥í•œ IFë¥¼ ì„ íƒí•˜ì—¬ ë˜ ë‹¤ë¥¸ ë¯¸ë˜ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.";

  sendAutoDelete(chatId, welcome, mainKeyboard);

  setTimeout(() => {
    bot.deleteMessage(chatId, msgId).catch(() => {});
  }, 60000);
});

bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  const msgId = msg.message_id;

  const helpMsg =
    "ğŸ“Œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:\n\n/start - IF í”„ë¡œì íŠ¸ ì•ˆë‚´ ë° ë²„íŠ¼\n/if - IF ë¦¬í¬íŠ¸ í™•ì¸\n/help - ì‚¬ìš©ë²• ì•ˆë‚´";

  sendAutoDelete(chatId, helpMsg);

  setTimeout(() => {
    bot.deleteMessage(chatId, msgId).catch(() => {});
  }, 60000);
});

bot.onText(/\/if/, (msg) => {
  const chatId = msg.chat.id;
  const msgId = msg.message_id;
  const today = getTodayKey();

  if (!usageTracker[chatId]) usageTracker[chatId] = {};
  if (!usageTracker[chatId][today]) usageTracker[chatId][today] = 0;

  if (usageTracker[chatId][today] >= 5) {
    sendAutoDelete(chatId, "âš ï¸ í•˜ë£¨ 5íšŒê¹Œì§€ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”. ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
  } else {
    usageTracker[chatId][today]++;
    const random = ifResponses[Math.floor(Math.random() * ifResponses.length)];
    sendAutoDelete(chatId, `ğŸ“¡ IF ë¦¬í¬íŠ¸:\n\n${random}`);
  }

  setTimeout(() => {
    bot.deleteMessage(chatId, msgId).catch(() => {});
  }, 60000);
});

bot.on("callback_query", (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;
  const today = getTodayKey();

  if (!usageTracker[chatId]) usageTracker[chatId] = {};
  if (!usageTracker[chatId][today]) usageTracker[chatId][today] = 0;

  if (data === "trigger_if") {
    if (usageTracker[chatId][today] >= 5) {
      sendAutoDelete(chatId, "âš ï¸ í•˜ë£¨ 5íšŒê¹Œì§€ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”. ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    } else {
      usageTracker[chatId][today]++;
      const random = ifResponses[Math.floor(Math.random() * ifResponses.length)];
      sendAutoDelete(chatId, `ğŸ“¡ IF ë¦¬í¬íŠ¸:\n\n${random}`);
    }
  }

  bot.answerCallbackQuery(query.id);
});
